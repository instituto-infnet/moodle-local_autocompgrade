<html>
    <head>
        <script
            type="text/javascript"
            src="../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
/**
 * P&aacute;gina para for&ccedil;ar manualmente o c&aacute;lculo de resultados.
 *
 * A p&aacute;gina cont&eacute;m duas se&ccedil;&otilde;es:
 * 1. Um formul&aacute;rio para selecionar um curso e estudantes espec&iacute;ficos e for&ccedil;ar
 * o c&aacute;lculo de resultados, caso haja alguma diferen&ccedil;a com o que est&aacute; gravado.
 * 1. Um relat&oacute;rio com estudantes que est&atilde;o com as compet&ecirc;ncias atualizadas
 * ou n&atilde;o.
 *
 * @package    local_autocompgrade
 * @copyright  2017 Instituto Infnet {@link http://infnet.edu.br}
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/

require_once(__DIR__ . '/../../config.php');
require_once(__DIR__ . '/classes/autocompgrade.php');
require_once(__DIR__ . '/classes/gradeassigncompetencies_form.php');
require_once($CFG-&gt;libdir . '/adminlib.php');

global $DB;

$courses = optional_param('disciplinas', null, PARAM_RAW);
$pageparams = array(
	'course' =&gt; optional_param('course', null, PARAM_INT),
	'userid' =&gt; optional_param('userid', null, PARAM_INT),
);
$atualizar_todas = optional_param('atualizar_todas', null, PARAM_BOOL);

$indexcourseid = 5;
$indexuserid = 6;

if (isset($courses)) {
	$pageparams['course'] = $courses[$indexcourseid];
	$pageparams['userid'] = $courses[$indexuserid];
} else if (isset($pageparams['course']) || isset($pageparams['userid'])) {
	if (isset($pageparams['course'])) {
		$courses[$indexcourseid] = $pageparams['course'];
	}

	if (isset($pageparams['userid'])) {
		$courses[$indexuserid] = $pageparams['userid'];
	}
}

$url = '/local/autocompgrade/gradeassigncompetencies.php';

$PAGE-&gt;set_url($url, $pageparams);
$context = context_system::instance();
$PAGE-&gt;set_context($context);
$PAGE-&gt;set_title(get_string('pluginname', 'local_autocompgrade'));
$PAGE-&gt;set_pagelayout('admin');

admin_externalpage_setup('local_autocompgrade_gradeassigncompetencies');

require_login();
require_capability('moodle/competency:competencymanage', $context);

echo $OUTPUT-&gt;header() . $OUTPUT-&gt;heading(get_string('gradeassigncompetencies', 'local_autocompgrade'));

$pageparams['disciplinas'] = $courses;

if (isset($pageparams['disciplinas']) &amp;&amp; !in_array(0, $pageparams)) {
	echo local_autocompgrade\autocompgrade::gradeassigncompetencies_printableresult($pageparams['disciplinas'][$indexcourseid], $pageparams['disciplinas'][$indexuserid]);
}
$courses = $DB-&gt;get_records_sql('
	select CONCAT(disciplinas.disciplinaid, &quot;-&quot;, disciplinas.estudanteid) course_usrid,
		CONCAT(disciplinas.endyear, &quot;T&quot;, disciplinas.endtrimester) trimestre,
		disciplinas.escolaid,
		disciplinas.escola,
		disciplinas.programaid,
		disciplinas.programa,
		disciplinas.classeid,
		disciplinas.classe,
		disciplinas.blocoid,
		disciplinas.bloco,
		disciplinas.disciplinaid,
		disciplinas.disciplina,
		disciplinas.estudanteid,
		CONCAT(disciplinas.firstname, &quot; &quot;, disciplinas.lastname) estudante,
		MIN(competencia_atualizada) competenciasatualizadas
	from (
		select
			disciplina.id disciplinaid,
			usr.id estudanteid,
			acgc.endyear,
			acgc.endtrimester,
			escola.id escolaid,
			escola.name escola,
			programa.id programaid,
			programa.name programa,
			classe.id classeid,
			classe.name classe,
			bloco.id blocoid,
			bloco.name bloco,
			disciplina.fullname disciplina,
			usr.firstname,
			usr.lastname,
			ccomp.competencyid,
			(
				select
					case
						when (AVG(resultados.grau) is not null and usercomp.grade is null)
							or usercomp.grade &lt;&gt;
								case
									when AVG(resultados.grau) &lt; 0.5 then 1
									when AVG(resultados.grau) &lt; 0.75 then 2
									when AVG(resultados.grau) &lt; 1 then 3
									when AVG(resultados.grau) = 1 then 4
								end
							then &quot;N&atilde;o&quot;
							else &quot;Sim&quot;
					end competencia_atualizada
				from (
					(
						select cm.course,
							ag.userid,
							ag.timemodified,
							comp.id competencyid,
							case when grl.score &gt; 0 then 1 else 0 end grau
						from {local_autocompgrade_courses} acgc
							join {course_modules} cm on cm.course = acgc.course
							join {competency_modulecomp} cmcomp on cmcomp.cmid = cm.id
							join {competency} comp on comp.id = cmcomp.competencyid
							join {modules} m on m.id = cm.module
								and m.name = &quot;assign&quot;
							join {context} c on c.instanceid = cm.id
							join {grading_areas} ga on ga.contextid = c.id
							join {grading_definitions} gd on gd.areaid = ga.id
							join {grading_instances} gin on gin.definitionid = gd.id
								and gin.status = 1
							join {assign_grades} ag on ag.id = gin.itemid
							join {assign} asg on asg.id = ag.assignment
							join {gradingform_rubric_fillings} grf on grf.instanceid = gin.id
							join {gradingform_rubric_criteria} grc on grc.id = grf.criterionid
								and LEFT(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(grc.description, &quot;[c]&quot;, &quot;&quot;), &quot;\n&quot;, &quot;&quot;), &quot;\r&quot;, &quot;&quot;), &quot;\t&quot;, &quot;&quot;), &quot; &quot;, &quot;&quot;), LOCATE(&quot;.&quot;, REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(grc.description, &quot;[c]&quot;, &quot;&quot;), &quot;\n&quot;, &quot;&quot;), &quot;\r&quot;, &quot;&quot;), &quot;\t&quot;, &quot;&quot;), &quot; &quot;, &quot;&quot;)) - 1) = comp.idnumber
							join {gradingform_rubric_levels} grl on grl.criterionid = grc.id
							  and grf.levelid = grl.id
						where ag.id = (
							select ag_maisrecente.id
							from {assign_grades} ag_maisrecente
							where ag_maisrecente.assignment = asg.id
								and ag_maisrecente.userid = ag.userid
							order by ag_maisrecente.timemodified desc
							limit 1
						)

						union all

						select cm.course,
							u.id userid,
							qa.timemodified,
							comp.id competencyid,
							case
								when qas.state = &quot;gradedright&quot; or qas.fraction = qatt.maxmark then 1
								else 0
							end grau
						from {quiz} as q
							join {course_modules} as cm on cm.instance = q.id
							join {local_autocompgrade_courses} acgc on acgc.course = cm.course
							join {modules} m on m.id = cm.module
								and m.name = &quot;quiz&quot;
							join {competency_modulecomp} cmcomp on cmcomp.cmid = cm.id
							join {competency} comp on comp.id = cmcomp.competencyid
							join {quiz_attempts} qa on q.id = qa.quiz
							join {question_usages} as qu on qu.id = qa.uniqueid
							join {user} as u on u.id = qa.userid
							join {question_attempts} as qatt on qatt.questionusageid = qu.id
							join {question} as question on question.id = qatt.questionid
								and LEFT(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(question.name, &quot;[&quot;, &quot;&quot;), &quot;\n&quot;, &quot;&quot;), &quot;\r&quot;, &quot;&quot;), &quot;\t&quot;, &quot;&quot;), &quot; &quot;, &quot;&quot;), LOCATE(&quot;]&quot;, REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(question.name, &quot;[&quot;, &quot;&quot;), &quot;\n&quot;, &quot;&quot;), &quot;\r&quot;, &quot;&quot;), &quot;\t&quot;, &quot;&quot;), &quot; &quot;, &quot;&quot;)) - 1) = comp.idnumber
							join {question_attempt_steps} as qas on qas.questionattemptid = qatt.id
								and qas.id = (
									select sortqas.id
									from {question_attempt_steps} sortqas
									where sortqas.questionattemptid = qatt.id
									order by sortqas.timecreated desc
									limit 1
								)
					) resultados
				)
					left join {competency_usercompcourse} usercomp on usercomp.competencyid = resultados.competencyid
						and usercomp.userid = resultados.userid
				where resultados.course = acgc.course
					and resultados.userid = usr.id
					and resultados.competencyid = ccomp.competencyid
			) competencia_atualizada
		from {local_autocompgrade_courses} acgc
			join {course} disciplina on disciplina.id = acgc.course
			join {course_categories} bloco on bloco.id = disciplina.category
			join {course_categories} classe on classe.id = bloco.parent
			join {course_categories} programa on programa.id = classe.parent
			join {course_categories} escola on escola.id = programa.parent
			join {competency_coursecomp} ccomp on ccomp.courseid = acgc.course
			join {context} ctx on ctx.instanceid = acgc.course
				and ctx.contextlevel = 50
			join {role_assignments} ra on ra.contextid = ctx.id
			join {role} r on r.id = ra.roleid
				and r.shortname = &quot;student&quot;
			join {user} usr on usr.id = ra.userid
		group by acgc.course,
			usr.id,
			ccomp.competencyid
	) disciplinas
	group by disciplinas.disciplinaid,
		disciplinas.estudanteid
	order by trimestre,
		disciplinas.escola,
		disciplinas.programa,
		disciplinas.classe,
		disciplinas.bloco,
		disciplinas.disciplina,
		estudante
');

$selectoptions = array();
$selectoptions['trimestres'] = array();
$selectoptions['escolas'] = array();
$selectoptions['programas'] = array();
$selectoptions['classes'] = array();
$selectoptions['blocos'] = array();
$selectoptions['disciplinas'] = array();
$selectoptions['estudantes'] = array();

$tabledatadesatualizadas = array();
$tabledataatualizadas = array();
$contagem = 0;

foreach ($courses as $dados) {
	if (!isset($selectoptions['trimestres'][$dados-&gt;trimestre])) {
		$selectoptions['trimestres'][$dados-&gt;trimestre] = $dados-&gt;trimestre;
	}

	if (!isset($selectoptions['escolas'][$dados-&gt;trimestre][$dados-&gt;escolaid])) {
		$selectoptions['escolas'][$dados-&gt;trimestre][$dados-&gt;escolaid] = $dados-&gt;escola;
	}

	if (!isset($selectoptions['programas'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid])) {
		$selectoptions['programas'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid] = $dados-&gt;programa;
	}

	if (!isset($selectoptions['classes'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid][$dados-&gt;classeid])) {
		$selectoptions['classes'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid][$dados-&gt;classeid] = $dados-&gt;classe;
	}

	if (!isset($selectoptions['blocos'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid][$dados-&gt;classeid][$dados-&gt;blocoid])) {
		$selectoptions['blocos'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid][$dados-&gt;classeid][$dados-&gt;blocoid] = $dados-&gt;bloco;
	}

	if (!isset($selectoptions['disciplinas'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid][$dados-&gt;classeid][$dados-&gt;blocoid][$dados-&gt;disciplinaid])) {
		$selectoptions['disciplinas'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid][$dados-&gt;classeid][$dados-&gt;blocoid][$dados-&gt;disciplinaid] = $dados-&gt;disciplina;
	}

	if (!isset($selectoptions['estudantes'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid][$dados-&gt;classeid][$dados-&gt;blocoid][$dados-&gt;disciplinaid][$dados-&gt;estudanteid])) {
		$selectoptions['estudantes'][$dados-&gt;trimestre][$dados-&gt;escolaid][$dados-&gt;programaid][$dados-&gt;classeid][$dados-&gt;blocoid][$dados-&gt;disciplinaid][$dados-&gt;estudanteid] = $dados-&gt;estudante;
	}

	$var_tabledata = ($dados-&gt;competenciasatualizadas === 'Sim') ? 'tabledataatualizadas' : 'tabledatadesatualizadas';
	${$var_tabledata}[] = array(
		html_writer::link(
			new moodle_url(
				$url,
				array(
					'course' =&gt; $dados-&gt;disciplinaid,
					'userid' =&gt; $dados-&gt;estudanteid
				)
			),
			html_writer::img(
				$OUTPUT-&gt;pix_url('i/competencies'),
				get_string('gradeassigncompetencies_submit', 'local_autocompgrade')
			)
		),
		sizeof(${$var_tabledata}) + 1 . '.',
		html_writer::link(
			new moodle_url(
				'/course/view.php',
				array(
					'id' =&gt; $dados-&gt;disciplinaid
				)
			),
			implode(' &gt; ', array($dados-&gt;trimestre,  $dados-&gt;escola, $dados-&gt;programa, $dados-&gt;classe, $dados-&gt;bloco, $dados-&gt;disciplina)),
			array(
				'target' =&gt; '_blank'
			)
		),
		html_writer::link(
			new moodle_url(
				'/report/competency/index.php',
				array(
					'id' =&gt; $dados-&gt;disciplinaid,
					'user' =&gt; $dados-&gt;estudanteid
				)
			),
			$dados-&gt;estudante,
			array(
				'target' =&gt; '_blank'
			)
		),
		$dados-&gt;competenciasatualizadas
	);

	if ($atualizar_todas === 1 &amp;&amp; $dados-&gt;competenciasatualizadas === 'N&atilde;o' &amp;&amp; $contagem &lt; 100) {
		$result = local_autocompgrade\autocompgrade::gradeassigncompetencies_printableresult($dados-&gt;disciplinaid, $dados-&gt;estudanteid);

		echo $result;

		if (strpos($result, 'Erro') === false) {
			$contagem++;
		}
	}
}

$pageparams['selectoptions'] = $selectoptions;

echo html_writer::tag('h3', get_string('gradeassigncompetencies_instruction', 'local_autocompgrade'));

$mform = new gradeassigncompetencies_form(null, $pageparams);

$mform-&gt;display();

$tablehead = array(
	get_string('gradeassigncompetencies_submit', 'local_autocompgrade'),
	'#',
	get_string('course', 'local_autocompgrade'),
	get_string('gradeassigncompetencies_student', 'local_autocompgrade'),
	get_string('gradeassigncompetencies_updatedgradesheader', 'local_autocompgrade')
);

echo html_writer::tag('h3', get_string('gradeassigncompetencies_notupdatedgrades', 'local_autocompgrade'));

$table = new html_table();
$table-&gt;head = $tablehead;
$table-&gt;data = $tabledatadesatualizadas;

echo html_writer::table($table);

echo html_writer::tag('h3', get_string('gradeassigncompetencies_updatedgrades', 'local_autocompgrade'));

$table = new html_table();
$table-&gt;head = $tablehead;
$table-&gt;data = $tabledataatualizadas;

echo html_writer::table($table);

echo $OUTPUT-&gt;footer();
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>